<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="/static/pico.min.css" />
<link rel="stylesheet" href="/static/css/themes/amber.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.1/flexboxgrid.min.css"
  type="text/css">

<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
</head>

<body>
  <main class="container center-sm">
    <hgroup>
      <h1 style="color:#ffb300">Welcome to {{ title }}!</h1>
      <p>A Basic Bitcoin to Fiat converter with price feeds from Coindesk.</p>
    </hgroup>

    <section id="converter">
        <div class="grid">

          <div class="row center-sm">
            <div class="col-sm-4">
               <button class="primary outline" type="" disabled>BTC</button>
            </div>
            <div class="col-sm-6">
              <input type="text"
                      id="satsamt"
                      name="satsamt"
                      placeholder="1.0"
                      aria-label="btc"
                      value="{{satsamt}}">
            </div>
          </div>
          <div class="row center-sm">
            <div class="col-sm-4" id="app">
              <form id="my-form" action="convert" method="post">
              <select id="selected" name="selected">
                <!-- todo make dyanmic -->
                  <option value="HKD">HKD</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                </select>
              </form>
            </div>
            <div class="col-sm-6">
              <input type="text"
                      name="fiat"
                      id="fiat"
                      aria-label="fiat"
                      value="{{fiat}}">
            </div>
          </div>
        </div>
      <label>
        1 BTC = {{fiat}} {{fiattype}}
      </label>
    </section>

    <!-- <button type="submit">Go</button> -->
    <section id="ticker">
      <p>
        $ {{ btcprice }} USD / BTC <br />
        Moscow Time {{ moscow }} (sats/usd) <br />
        Block Height {{ blockheight }}  <br/>
        As of {{lastupdated}} <br />
      </p>
    </section>
    <footer>
      Built with <a href="https://picocss.com"> Pico </a> â€¢ By <a href="https://github.com/bitkarrot"> BitKarrot </a>
    </footer>
  </main>

  <script>
    const dropdown = document.getElementById('selected')
    const form = document.getElementById('my-form')
    const fiatamt = document.getElementById('fiat')
    const satsamt = document.getElementById('satsamt')

    const rate = fiatamt.value // 1 btc = fiat amt

    dropdown.addEventListener('change', () => {
      console.log(dropdown.value)
      form.submit();
    })

    // add input listener for in-page rate conversion
    fiatamt.addEventListener('input', (event) => {
      const userInput = event.target.value;
      const regex = /^\d+(\.\d{0,2})?$/;
      const isValid = regex.test(userInput);
      if (!isValid) {
        event.target.value = userInput.slice(0, -1);
      }
      const result = parseFloat(userInput) / rate;  // convert btc to fiat rate
      console.log(rate)
      satsamt.value = result.toFixed(8);
    });

    // allow for decimals!!
    satsamt.addEventListener('input', (event) => {
      const userInput = event.target.value;
      const regex = /^\d+(\.\d{0,2})?$/;
      const isValid = regex.test(userInput);
      if (!isValid) {
        event.target.value = userInput.slice(0, -1);
      }
      const result = parseFloat(userInput) * rate;  // convert sats to fiat rate
      console.log(rate)
      fiatamt.value = result.toFixed(2);
    });


  </script>

</body>
</html>